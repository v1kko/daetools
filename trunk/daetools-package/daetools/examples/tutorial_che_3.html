<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="Generator" content="Kate, the KDE Advanced Text Editor" />
<title>tutorial_che_3.py</title>
</head>
<body>
<pre style='color:#1f1c1b;background-color:#ffffff;'>
<span style='color:#008000;'>#!/usr/bin/env python</span>
<span style='color:#008000;'># -*- coding: utf-8 -*-</span>

<span style='color:#008000;'>&quot;&quot;&quot;</span>
<span style='color:#008000;'>***********************************************************************************</span>
<span style='color:#008000;'>                           tutorial_che_3.py</span>
<span style='color:#008000;'>                DAE Tools: pyDAE module, www.daetools.com</span>
<span style='color:#008000;'>                Copyright (C) Dragan Nikolic, 2016</span>
<span style='color:#008000;'>***********************************************************************************</span>
<span style='color:#008000;'>DAE Tools is free software; you can redistribute it and/or modify it under the</span>
<span style='color:#008000;'>terms of the GNU General Public License version 3 as published by the Free Software</span>
<span style='color:#008000;'>Foundation. DAE Tools is distributed in the hope that it will be useful, but WITHOUT</span>
<span style='color:#008000;'>ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A</span>
<span style='color:#008000;'>PARTICULAR PURPOSE. See the GNU General Public License for more details.</span>
<span style='color:#008000;'>You should have received a copy of the GNU General Public License along with the</span>
<span style='color:#008000;'>DAE Tools software; if not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span style='color:#008000;'>************************************************************************************</span>
<span style='color:#008000;'>&quot;&quot;&quot;</span>
__doc__ <b><span style='color:#0000ff;'>=</span></b> <span style='color:#c00000;'>&quot;&quot;&quot;</span>
<span style='color:#c00000;'>Batch reactor seeded crystallization using the method of moments.</span>

<span style='color:#c00000;'>References (model equations and input parameters):</span>

<span style='color:#c00000;'>- Nikolic D.D., Frawley P.J. (2016) Application of the Lagrangian Meshfree Approach</span>
<span style='color:#c00000;'>  to Modelling of Batch Crystallisation: Part I – Modelling of Stirred Tank Hydrodynamics.</span>
<span style='color:#c00000;'>  Chemical Engineering Science 145:317–328.</span>
<span style='color:#c00000;'>  `doi:10.1016/j.ces.2015.08.052 &lt;http://dx.doi.org/10.1016/j.ces.2015.08.052&gt;`_</span>
<span style='color:#c00000;'>- Mitchell N.A., O’Ciardha C.T., Frawley P.J. (2011) Estimation of the growth kinetics</span>
<span style='color:#c00000;'>  for the cooling crystallisation of paracetamol and ethanol solutions.</span>
<span style='color:#c00000;'>  Journal of Crystal Growth 328:39–49.</span>
<span style='color:#c00000;'>  `doi:10.1016/j.jcrysgro.2011.06.016 &lt;http://dx.doi.org/10.1016/j.jcrysgro.2011.06.016&gt;`_</span>

<span style='color:#c00000;'>The main assumptions:</span>

<span style='color:#c00000;'>- Seeded crystallization</span>
<span style='color:#c00000;'>- Ideal mixing</span>
<span style='color:#c00000;'>- Fixed cooling rate</span>
<span style='color:#c00000;'>- Size independent growth</span>

<span style='color:#c00000;'>Solubility of Paracetamol in ethanol:</span>

<span style='color:#c00000;'>.. code-block:: none</span>

<span style='color:#c00000;'>   ---------------------------------------------------------------------------------</span>
<span style='color:#c00000;'>   Temperature, C | Solubility, kg Parac./kg EtOH   | Solubility, mol Parac./m3 EtOH</span>
<span style='color:#c00000;'>   ---------------------------------------------------------------------------------</span>
<span style='color:#c00000;'>   0              | 0.11362                         | 593.0387</span>
<span style='color:#c00000;'>   10             | 0.14128                         | 737.4215</span>
<span style='color:#c00000;'>   20             | 0.17568                         | 916.9562</span>
<span style='color:#c00000;'>   30             | 0.21845                         | 1140.2008</span>
<span style='color:#c00000;'>   40             | 0.27163                         | 1417.7972</span>
<span style='color:#c00000;'>   50             | 0.33777                         | 1762.9779</span>
<span style='color:#c00000;'>   60             | 0.42000                         | 2192.1973</span>
<span style='color:#c00000;'>   ---------------------------------------------------------------------------------</span>

<span style='color:#c00000;'>The supersaturation plot:</span>

<span style='color:#c00000;'>.. image:: _static/tutorial_che_3-results.png</span>
<span style='color:#c00000;'>   :width: 500px</span>

<span style='color:#c00000;'>The concentration plot:</span>

<span style='color:#c00000;'>.. image:: _static/tutorial_che_3-results2.png</span>
<span style='color:#c00000;'>   :width: 500px</span>

<span style='color:#c00000;'>The recovery plot:</span>

<span style='color:#c00000;'>.. image:: _static/tutorial_che_3-results3.png</span>
<span style='color:#c00000;'>   :width: 500px</span>

<span style='color:#c00000;'>The yield plot:</span>

<span style='color:#c00000;'>.. image:: _static/tutorial_che_3-results4.png</span>
<span style='color:#c00000;'>   :width: 500px</span>

<span style='color:#c00000;'>The total number of crystals plot:</span>

<span style='color:#c00000;'>.. image:: _static/tutorial_che_3-results5.png</span>
<span style='color:#c00000;'>   :width: 500px</span>
<span style='color:#c00000;'>&quot;&quot;&quot;</span>

<span style='color:#0000ff;'>import</span> sys, numpy
<span style='color:#0000ff;'>from</span> daetools.pyDAE <span style='color:#0000ff;'>import</span> <b><span style='color:#0000ff;'>*</span></b>
<span style='color:#0000ff;'>from</span> time <span style='color:#0000ff;'>import</span> localtime, strftime

<span style='color:#008000;'># Standard variable types are defined in variable_types.py</span>
<span style='color:#0000ff;'>from</span> pyUnits <span style='color:#0000ff;'>import</span> m, g, kg, s, K, mol, kmol, J, um

pbm_growth_rate_t                <b><span style='color:#0000ff;'>=</span></b> daeVariableType(<span style='color:#c00000;'>&quot;pbm_growth_rate_t&quot;</span>,                m<b><span style='color:#0000ff;'>/</span></b>s,                    <span style='color:#c000c0;'>0.0</span>, <span style='color:#c000c0;'>1.0e+20</span>,  <span style='color:#c000c0;'>0.1</span>, <span style='color:#c000c0;'>1e-05</span>)
pbm_birth_rate_t                 <b><span style='color:#0000ff;'>=</span></b> daeVariableType(<span style='color:#c00000;'>&quot;pbm_birth_rate_t&quot;</span>,                 (s<b><span style='color:#0000ff;'>**</span></b>(<b><span style='color:#0000ff;'>-</span></b><span style='color:#c000c0;'>1</span>)) <b><span style='color:#0000ff;'>*</span></b> (m<b><span style='color:#0000ff;'>**</span></b>(<b><span style='color:#0000ff;'>-</span></b><span style='color:#c000c0;'>3</span>)),  <span style='color:#c000c0;'>0.0</span>, <span style='color:#c000c0;'>1.0e+20</span>,  <span style='color:#c000c0;'>0.0</span>, <span style='color:#c000c0;'>1e-05</span>)
pbm_death_rate_t                 <b><span style='color:#0000ff;'>=</span></b> daeVariableType(<span style='color:#c00000;'>&quot;pbm_death_rate_t&quot;</span>,                 (s<b><span style='color:#0000ff;'>**</span></b>(<b><span style='color:#0000ff;'>-</span></b><span style='color:#c000c0;'>1</span>)) <b><span style='color:#0000ff;'>*</span></b> (m<b><span style='color:#0000ff;'>**</span></b>(<b><span style='color:#0000ff;'>-</span></b><span style='color:#c000c0;'>3</span>)),  <span style='color:#c000c0;'>0.0</span>, <span style='color:#c000c0;'>1.0e+20</span>,  <span style='color:#c000c0;'>0.0</span>, <span style='color:#c000c0;'>1e-05</span>)
pbm_solution_concentration_t     <b><span style='color:#0000ff;'>=</span></b> daeVariableType(<span style='color:#c00000;'>&quot;pbm_solution_concentration_t&quot;</span>,     kg<b><span style='color:#0000ff;'>/</span></b>kg,                  <span style='color:#c000c0;'>0.0</span>, <span style='color:#c000c0;'>1.0e+20</span>,  <span style='color:#c000c0;'>0.1</span>, <span style='color:#c000c0;'>1e-05</span>)
pbm_solution_concentration_vol_t <b><span style='color:#0000ff;'>=</span></b> daeVariableType(<span style='color:#c00000;'>&quot;pbm_solution_concentration_vol_t&quot;</span>, kmol<b><span style='color:#0000ff;'>/</span></b>(m<b><span style='color:#0000ff;'>**</span></b><span style='color:#c000c0;'>3</span>),            <span style='color:#c000c0;'>0.0</span>, <span style='color:#c000c0;'>1.0e+20</span>,  <span style='color:#c000c0;'>0.1</span>, <span style='color:#c000c0;'>1e-05</span>)

pbm_number_t  <b><span style='color:#0000ff;'>=</span></b> daeVariableType(<span style='color:#c00000;'>&quot;pbm_number_t&quot;</span>,  m<b><span style='color:#0000ff;'>**</span></b>(<b><span style='color:#0000ff;'>-</span></b><span style='color:#c000c0;'>3</span>),           <span style='color:#c000c0;'>0.0</span>, <span style='color:#c000c0;'>1.0e+20</span>,  <span style='color:#c000c0;'>0.0</span>, <span style='color:#c000c0;'>1e-05</span>)
pbm_length_t  <b><span style='color:#0000ff;'>=</span></b> daeVariableType(<span style='color:#c00000;'>&quot;pbm_length_t&quot;</span>,  m<b><span style='color:#0000ff;'>/</span></b>(m<b><span style='color:#0000ff;'>**</span></b><span style='color:#c000c0;'>3</span>),          <span style='color:#c000c0;'>0.0</span>, <span style='color:#c000c0;'>1.0e+20</span>,  <span style='color:#c000c0;'>0.0</span>, <span style='color:#c000c0;'>1e-06</span>)
pbm_area_t    <b><span style='color:#0000ff;'>=</span></b> daeVariableType(<span style='color:#c00000;'>&quot;pbm_area_t&quot;</span>,    (m<b><span style='color:#0000ff;'>**</span></b><span style='color:#c000c0;'>2</span>)<b><span style='color:#0000ff;'>/</span></b>(m<b><span style='color:#0000ff;'>**</span></b><span style='color:#c000c0;'>3</span>),     <span style='color:#c000c0;'>0.0</span>, <span style='color:#c000c0;'>1.0e+20</span>,  <span style='color:#c000c0;'>0.0</span>, <span style='color:#c000c0;'>1e-08</span>)
pbm_volume_t  <b><span style='color:#0000ff;'>=</span></b> daeVariableType(<span style='color:#c00000;'>&quot;pbm_volume_t&quot;</span>,  (m<b><span style='color:#0000ff;'>**</span></b><span style='color:#c000c0;'>3</span>)<b><span style='color:#0000ff;'>/</span></b>(m<b><span style='color:#0000ff;'>**</span></b><span style='color:#c000c0;'>3</span>),     <span style='color:#c000c0;'>0.0</span>, <span style='color:#c000c0;'>1.0e+20</span>,  <span style='color:#c000c0;'>0.0</span>, <span style='color:#c000c0;'>1e-10</span>)
pbm_moment4_t <b><span style='color:#0000ff;'>=</span></b> daeVariableType(<span style='color:#c00000;'>&quot;pbm_moment4_t&quot;</span>, (m<b><span style='color:#0000ff;'>**</span></b><span style='color:#c000c0;'>4</span>)<b><span style='color:#0000ff;'>/</span></b>(m<b><span style='color:#0000ff;'>**</span></b><span style='color:#c000c0;'>3</span>),     <span style='color:#c000c0;'>0.0</span>, <span style='color:#c000c0;'>1.0e+20</span>,  <span style='color:#c000c0;'>0.0</span>, <span style='color:#c000c0;'>1e-11</span>)
pbm_moment5_t <b><span style='color:#0000ff;'>=</span></b> daeVariableType(<span style='color:#c00000;'>&quot;pbm_moment5_t&quot;</span>, (m<b><span style='color:#0000ff;'>**</span></b><span style='color:#c000c0;'>5</span>)<b><span style='color:#0000ff;'>/</span></b>(m<b><span style='color:#0000ff;'>**</span></b><span style='color:#c000c0;'>3</span>),     <span style='color:#c000c0;'>0.0</span>, <span style='color:#c000c0;'>1.0e+20</span>,  <span style='color:#c000c0;'>0.0</span>, <span style='color:#c000c0;'>1e-12</span>)

pbm_diameter_t <b><span style='color:#0000ff;'>=</span></b> daeVariableType(<span style='color:#c00000;'>&quot;pbm_diameter_t&quot;</span>,  m, <span style='color:#c000c0;'>0.0</span>, <span style='color:#c000c0;'>1.0e+20</span>,  <span style='color:#c000c0;'>0.0</span>, <span style='color:#c000c0;'>1e-10</span>)

<b>class</b> modTutorial(daeModel):
    <b>def</b> <b><span style='color:#000e52;'>__init__</span></b>(<span style='color:#0000ff;'>self</span>, Name, Parent <b><span style='color:#0000ff;'>=</span></b> <span style='color:#0000ff;'>None</span>, Description <b><span style='color:#0000ff;'>=</span></b> <span style='color:#c00000;'>&quot;&quot;</span>):
        daeModel.<b><span style='color:#000e52;'>__init__</span></b>(<span style='color:#0000ff;'>self</span>, Name, Parent, Description)

        <span style='color:#0000ff;'>self</span>.n <b><span style='color:#0000ff;'>=</span></b> <span style='color:#c000c0;'>2.276</span> <span style='color:#008000;'># Nucleation rate exponent</span>
        <span style='color:#0000ff;'>self</span>.g <b><span style='color:#0000ff;'>=</span></b> <span style='color:#c000c0;'>1.602</span> <span style='color:#008000;'># Growth rate exponent</span>
        kg_units <b><span style='color:#0000ff;'>=</span></b> (m<b><span style='color:#0000ff;'>/</span></b>s)<b><span style='color:#0000ff;'>*</span></b>(((m<b><span style='color:#0000ff;'>**</span></b><span style='color:#c000c0;'>3</span>)<b><span style='color:#0000ff;'>/</span></b>kmol)<b><span style='color:#0000ff;'>**</span></b><span style='color:#c000c0;'>1.602</span>)
        kn_units <b><span style='color:#0000ff;'>=</span></b> (s<b><span style='color:#0000ff;'>**</span></b>(<b><span style='color:#0000ff;'>-</span></b><span style='color:#c000c0;'>1</span>))<b><span style='color:#0000ff;'>*</span></b>(m<b><span style='color:#0000ff;'>**</span></b>(<b><span style='color:#0000ff;'>-</span></b><span style='color:#c000c0;'>3</span>)) <b><span style='color:#0000ff;'>*</span></b> ((kg<b><span style='color:#0000ff;'>/</span></b>kg)<b><span style='color:#0000ff;'>**</span></b><span style='color:#c000c0;'>2.276</span>)

        <span style='color:#0000ff;'>self</span>.Nm <b><span style='color:#0000ff;'>=</span></b> daeDomain(<span style='color:#c00000;'>&quot;Nm&quot;</span>, <span style='color:#0000ff;'>self</span>, m, <span style='color:#c00000;'>&quot;Number of moments&quot;</span>)
        
        <span style='color:#0000ff;'>self</span>.R      <b><span style='color:#0000ff;'>=</span></b> daeParameter(<span style='color:#c00000;'>&quot;R&quot;</span>,     J<b><span style='color:#0000ff;'>/</span></b>(mol<b><span style='color:#0000ff;'>*</span></b>K), <span style='color:#0000ff;'>self</span>, <span style='color:#c00000;'>&quot;Universal gas constant&quot;</span>)
        <span style='color:#0000ff;'>self</span>.MW     <b><span style='color:#0000ff;'>=</span></b> daeParameter(<span style='color:#c00000;'>&quot;MW&quot;</span>,    kg<b><span style='color:#0000ff;'>/</span></b>kmol,   <span style='color:#0000ff;'>self</span>, <span style='color:#c00000;'>&quot;Molecular weight of paracetamol&quot;</span>)
        <span style='color:#0000ff;'>self</span>.V      <b><span style='color:#0000ff;'>=</span></b> daeParameter(<span style='color:#c00000;'>&quot;V&quot;</span>,     m<b><span style='color:#0000ff;'>**</span></b><span style='color:#c000c0;'>3</span>,      <span style='color:#0000ff;'>self</span>, <span style='color:#c00000;'>&quot;Volume of the suspension in the reactor&quot;</span>)
        <span style='color:#0000ff;'>self</span>.kg     <b><span style='color:#0000ff;'>=</span></b> daeParameter(<span style='color:#c00000;'>&quot;kg&quot;</span>,    kg_units,  <span style='color:#0000ff;'>self</span>, <span style='color:#c00000;'>&quot;Growth rate constant&quot;</span>)
        <span style='color:#0000ff;'>self</span>.Ea     <b><span style='color:#0000ff;'>=</span></b> daeParameter(<span style='color:#c00000;'>&quot;Ea&quot;</span>,    J<b><span style='color:#0000ff;'>/</span></b>mol,     <span style='color:#0000ff;'>self</span>, <span style='color:#c00000;'>&quot;Activation energy&quot;</span>)
        <span style='color:#0000ff;'>self</span>.kn     <b><span style='color:#0000ff;'>=</span></b> daeParameter(<span style='color:#c00000;'>&quot;kn&quot;</span>,    kn_units,  <span style='color:#0000ff;'>self</span>, <span style='color:#c00000;'>&quot;Nucleation rate constant&quot;</span>)
        <span style='color:#0000ff;'>self</span>.Kv     <b><span style='color:#0000ff;'>=</span></b> daeParameter(<span style='color:#c00000;'>&quot;Kv&quot;</span>,    unit(),    <span style='color:#0000ff;'>self</span>, <span style='color:#c00000;'>&quot;Volume shape factor&quot;</span>)
        <span style='color:#0000ff;'>self</span>.Ka     <b><span style='color:#0000ff;'>=</span></b> daeParameter(<span style='color:#c00000;'>&quot;Ka&quot;</span>,    unit(),    <span style='color:#0000ff;'>self</span>, <span style='color:#c00000;'>&quot;Surface area shape factor&quot;</span>)
        <span style='color:#0000ff;'>self</span>.rho_s  <b><span style='color:#0000ff;'>=</span></b> daeParameter(<span style='color:#c00000;'>&quot;rho_s&quot;</span>, kg<b><span style='color:#0000ff;'>/</span></b>(m<b><span style='color:#0000ff;'>**</span></b><span style='color:#c000c0;'>3</span>), <span style='color:#0000ff;'>self</span>, <span style='color:#c00000;'>&quot;Density of solution&quot;</span>)
        <span style='color:#0000ff;'>self</span>.cp_s   <b><span style='color:#0000ff;'>=</span></b> daeParameter(<span style='color:#c00000;'>&quot;cp_s&quot;</span>,  J<b><span style='color:#0000ff;'>/</span></b>(kg<b><span style='color:#0000ff;'>*</span></b>K),  <span style='color:#0000ff;'>self</span>, <span style='color:#c00000;'>&quot;Specific heat capacity of solution&quot;</span>)
        <span style='color:#0000ff;'>self</span>.rho_c  <b><span style='color:#0000ff;'>=</span></b> daeParameter(<span style='color:#c00000;'>&quot;rho_c&quot;</span>, kg<b><span style='color:#0000ff;'>/</span></b>(m<b><span style='color:#0000ff;'>**</span></b><span style='color:#c000c0;'>3</span>), <span style='color:#0000ff;'>self</span>, <span style='color:#c00000;'>&quot;Density of crystals&quot;</span>)
        <span style='color:#0000ff;'>self</span>.Qr     <b><span style='color:#0000ff;'>=</span></b> daeParameter(<span style='color:#c00000;'>&quot;Qr&quot;</span>,    W,         <span style='color:#0000ff;'>self</span>, <span style='color:#c00000;'>&quot;Cooling rate&quot;</span>)
        <span style='color:#0000ff;'>self</span>.L0     <b><span style='color:#0000ff;'>=</span></b> daeParameter(<span style='color:#c00000;'>&quot;L_0&quot;</span>,   m,         <span style='color:#0000ff;'>self</span>, <span style='color:#c00000;'>&quot;Initial size of the nucleus&quot;</span>)

        <span style='color:#0000ff;'>self</span>.m0     <b><span style='color:#0000ff;'>=</span></b> daeVariable(<span style='color:#c00000;'>&quot;m_0&quot;</span>,    pbm_number_t,                       <span style='color:#0000ff;'>self</span>, <span style='color:#c00000;'>&quot;Distribution moment 0&quot;</span>)
        <span style='color:#0000ff;'>self</span>.m1     <b><span style='color:#0000ff;'>=</span></b> daeVariable(<span style='color:#c00000;'>&quot;m_1&quot;</span>,    pbm_length_t,                       <span style='color:#0000ff;'>self</span>, <span style='color:#c00000;'>&quot;Distribution moment 1&quot;</span>)
        <span style='color:#0000ff;'>self</span>.m2     <b><span style='color:#0000ff;'>=</span></b> daeVariable(<span style='color:#c00000;'>&quot;m_2&quot;</span>,    pbm_area_t,                         <span style='color:#0000ff;'>self</span>, <span style='color:#c00000;'>&quot;Distribution moment 2&quot;</span>)
        <span style='color:#0000ff;'>self</span>.m3     <b><span style='color:#0000ff;'>=</span></b> daeVariable(<span style='color:#c00000;'>&quot;m_3&quot;</span>,    pbm_volume_t,                       <span style='color:#0000ff;'>self</span>, <span style='color:#c00000;'>&quot;Distribution moment 3&quot;</span>)
        <span style='color:#0000ff;'>self</span>.m4     <b><span style='color:#0000ff;'>=</span></b> daeVariable(<span style='color:#c00000;'>&quot;m_4&quot;</span>,    pbm_moment4_t,                      <span style='color:#0000ff;'>self</span>, <span style='color:#c00000;'>&quot;Distribution moment 4&quot;</span>)
        <span style='color:#0000ff;'>self</span>.m5     <b><span style='color:#0000ff;'>=</span></b> daeVariable(<span style='color:#c00000;'>&quot;m_5&quot;</span>,    pbm_moment5_t,                      <span style='color:#0000ff;'>self</span>, <span style='color:#c00000;'>&quot;Distribution moment 5&quot;</span>)
        <span style='color:#0000ff;'>self</span>.m_norm <b><span style='color:#0000ff;'>=</span></b> daeVariable(<span style='color:#c00000;'>&quot;m_norm&quot;</span>, no_t,                               <span style='color:#0000ff;'>self</span>, <span style='color:#c00000;'>&quot;Normalized distribution moments&quot;</span>, [<span style='color:#0000ff;'>self</span>.Nm])
        <span style='color:#0000ff;'>self</span>.T      <b><span style='color:#0000ff;'>=</span></b> daeVariable(<span style='color:#c00000;'>&quot;T&quot;</span>,      temperature_t,                      <span style='color:#0000ff;'>self</span>, <span style='color:#c00000;'>&quot;Solution temperature&quot;</span>)
        <span style='color:#0000ff;'>self</span>.G      <b><span style='color:#0000ff;'>=</span></b> daeVariable(<span style='color:#c00000;'>&quot;G&quot;</span>,      pbm_growth_rate_t,                  <span style='color:#0000ff;'>self</span>, <span style='color:#c00000;'>&quot;Growth rate&quot;</span>)
        <span style='color:#0000ff;'>self</span>.B      <b><span style='color:#0000ff;'>=</span></b> daeVariable(<span style='color:#c00000;'>&quot;B&quot;</span>,      pbm_birth_rate_t,                   <span style='color:#0000ff;'>self</span>, <span style='color:#c00000;'>&quot;Birth rate&quot;</span>)
        <span style='color:#0000ff;'>self</span>.c      <b><span style='color:#0000ff;'>=</span></b> daeVariable(<span style='color:#c00000;'>&quot;c&quot;</span>,      pbm_solution_concentration_t,       <span style='color:#0000ff;'>self</span>, <span style='color:#c00000;'>&quot;Solution concentration&quot;</span>)
        <span style='color:#0000ff;'>self</span>.c_star <b><span style='color:#0000ff;'>=</span></b> daeVariable(<span style='color:#c00000;'>&quot;c_star&quot;</span>, pbm_solution_concentration_t,       <span style='color:#0000ff;'>self</span>, <span style='color:#c00000;'>&quot;Solution equlibrium concentration (solubility)&quot;</span>)
        <span style='color:#0000ff;'>self</span>.delta_c<b><span style='color:#0000ff;'>=</span></b> daeVariable(<span style='color:#c00000;'>&quot;delta_c&quot;</span>,pbm_solution_concentration_vol_t,   <span style='color:#0000ff;'>self</span>, <span style='color:#c00000;'>&quot;Concentrations driving force&quot;</span>)
        <span style='color:#0000ff;'>self</span>.S      <b><span style='color:#0000ff;'>=</span></b> daeVariable(<span style='color:#c00000;'>&quot;S&quot;</span>,      no_t,                               <span style='color:#0000ff;'>self</span>, <span style='color:#c00000;'>&quot;Supersaturation&quot;</span>)
        
        <span style='color:#0000ff;'>self</span>.Yield      <b><span style='color:#0000ff;'>=</span></b> daeVariable(<span style='color:#c00000;'>&quot;Yield&quot;</span>,      mass_t,         <span style='color:#0000ff;'>self</span>, <span style='color:#c00000;'>&quot;Crystals yield&quot;</span>)
        <span style='color:#0000ff;'>self</span>.Yield_max  <b><span style='color:#0000ff;'>=</span></b> daeVariable(<span style='color:#c00000;'>&quot;Yield_max&quot;</span>,  mass_t,         <span style='color:#0000ff;'>self</span>, <span style='color:#c00000;'>&quot;Maximal crystals yield&quot;</span>)
        <span style='color:#0000ff;'>self</span>.Recovery   <b><span style='color:#0000ff;'>=</span></b> daeVariable(<span style='color:#c00000;'>&quot;Recovery&quot;</span>,   no_t,           <span style='color:#0000ff;'>self</span>, <span style='color:#c00000;'>&quot;Product recovery&quot;</span>)
        <span style='color:#0000ff;'>self</span>.Ntotal     <b><span style='color:#0000ff;'>=</span></b> daeVariable(<span style='color:#c00000;'>&quot;Ntotal&quot;</span>,     pbm_number_t,   <span style='color:#0000ff;'>self</span>, <span style='color:#c00000;'>&quot;Total number of crystals&quot;</span>)
        <span style='color:#0000ff;'>self</span>.Ltotal     <b><span style='color:#0000ff;'>=</span></b> daeVariable(<span style='color:#c00000;'>&quot;Ltotal&quot;</span>,     pbm_length_t,   <span style='color:#0000ff;'>self</span>, <span style='color:#c00000;'>&quot;Total length of crystals&quot;</span>)
        <span style='color:#0000ff;'>self</span>.Atotal     <b><span style='color:#0000ff;'>=</span></b> daeVariable(<span style='color:#c00000;'>&quot;Atotal&quot;</span>,     pbm_area_t,     <span style='color:#0000ff;'>self</span>, <span style='color:#c00000;'>&quot;Total surface area of crystals&quot;</span>)
        <span style='color:#0000ff;'>self</span>.Vtotal     <b><span style='color:#0000ff;'>=</span></b> daeVariable(<span style='color:#c00000;'>&quot;Vtotal&quot;</span>,     pbm_volume_t,   <span style='color:#0000ff;'>self</span>, <span style='color:#c00000;'>&quot;Total volume of crystals&quot;</span>)
        <span style='color:#0000ff;'>self</span>.D10        <b><span style='color:#0000ff;'>=</span></b> daeVariable(<span style='color:#c00000;'>&quot;D10&quot;</span>,        pbm_diameter_t, <span style='color:#0000ff;'>self</span>, <span style='color:#c00000;'>&quot;Mean size of crystals 1&quot;</span>)
        <span style='color:#0000ff;'>self</span>.D43        <b><span style='color:#0000ff;'>=</span></b> daeVariable(<span style='color:#c00000;'>&quot;D43&quot;</span>,        pbm_diameter_t, <span style='color:#0000ff;'>self</span>, <span style='color:#c00000;'>&quot;Mean size of crystals 2&quot;</span>)

    <b>def</b> DeclareEquations(<span style='color:#0000ff;'>self</span>):
        daeModel.DeclareEquations(<span style='color:#0000ff;'>self</span>)

        <span style='color:#008000;'># Heat balance</span>
        eq <b><span style='color:#0000ff;'>=</span></b> <span style='color:#0000ff;'>self</span>.CreateEquation(<span style='color:#c00000;'>&quot;T&quot;</span>, <span style='color:#c00000;'>&quot;&quot;</span>)
        eq.Residual <b><span style='color:#0000ff;'>=</span></b> <span style='color:#0000ff;'>self</span>.rho_s() <b><span style='color:#0000ff;'>*</span></b> <span style='color:#0000ff;'>self</span>.V() <b><span style='color:#0000ff;'>*</span></b> <span style='color:#0000ff;'>self</span>.cp_s() <b><span style='color:#0000ff;'>*</span></b> <span style='color:#0000ff;'>self</span>.T.dt() <b><span style='color:#0000ff;'>-</span></b> <span style='color:#0000ff;'>self</span>.Qr() <b><span style='color:#0000ff;'>*</span></b> (<span style='color:#0000ff;'>self</span>.T() <b><span style='color:#0000ff;'>-</span></b> Constant(<span style='color:#c000c0;'>273.14</span> <b><span style='color:#0000ff;'>*</span></b> K))<b><span style='color:#0000ff;'>/</span></b>Constant(<span style='color:#c000c0;'>1</span> <b><span style='color:#0000ff;'>*</span></b> K)

        <span style='color:#008000;'># Solution concentration</span>
        eq <b><span style='color:#0000ff;'>=</span></b> <span style='color:#0000ff;'>self</span>.CreateEquation(<span style='color:#c00000;'>&quot;c&quot;</span>, <span style='color:#c00000;'>&quot;&quot;</span>)
        eq.Residual <b><span style='color:#0000ff;'>=</span></b> <span style='color:#0000ff;'>self</span>.c.dt() <b><span style='color:#0000ff;'>+</span></b> <span style='color:#c000c0;'>3</span> <b><span style='color:#0000ff;'>*</span></b> <span style='color:#0000ff;'>self</span>.rho_c() <b><span style='color:#0000ff;'>*</span></b> <span style='color:#0000ff;'>self</span>.Kv() <b><span style='color:#0000ff;'>*</span></b> <span style='color:#0000ff;'>self</span>.G() <b><span style='color:#0000ff;'>*</span></b> <span style='color:#0000ff;'>self</span>.m2() <b><span style='color:#0000ff;'>/</span></b> <span style='color:#0000ff;'>self</span>.rho_s()

        <span style='color:#008000;'># Solubility (in kg/kg, as given in the paper)</span>
        eq <b><span style='color:#0000ff;'>=</span></b> <span style='color:#0000ff;'>self</span>.CreateEquation(<span style='color:#c00000;'>&quot;c_star&quot;</span>, <span style='color:#c00000;'>&quot;&quot;</span>)
        eq.Residual <b><span style='color:#0000ff;'>=</span></b> <span style='color:#0000ff;'>self</span>.c_star() <b><span style='color:#0000ff;'>-</span></b> <span style='color:#c000c0;'>2.955e-4</span> <b><span style='color:#0000ff;'>*</span></b> Exp(Constant(<span style='color:#c000c0;'>2.179e-2</span> <b><span style='color:#0000ff;'>*</span></b> <span style='color:#c000c0;'>1</span><b><span style='color:#0000ff;'>/</span></b>K) <b><span style='color:#0000ff;'>*</span></b> <span style='color:#0000ff;'>self</span>.T())

        eq <b><span style='color:#0000ff;'>=</span></b> <span style='color:#0000ff;'>self</span>.CreateEquation(<span style='color:#c00000;'>&quot;S&quot;</span>, <span style='color:#c00000;'>&quot;&quot;</span>)
        eq.Residual <b><span style='color:#0000ff;'>=</span></b> <span style='color:#0000ff;'>self</span>.S() <b><span style='color:#0000ff;'>-</span></b> <span style='color:#0000ff;'>self</span>.c() <b><span style='color:#0000ff;'>/</span></b> (<span style='color:#0000ff;'>self</span>.c_star() <b><span style='color:#0000ff;'>+</span></b> Constant(<span style='color:#c000c0;'>1e-20</span> <b><span style='color:#0000ff;'>*</span></b> kg<b><span style='color:#0000ff;'>/</span></b>kg))

        <span style='color:#008000;'># Nucleation kinetics</span>
        eq <b><span style='color:#0000ff;'>=</span></b> <span style='color:#0000ff;'>self</span>.CreateEquation(<span style='color:#c00000;'>&quot;B&quot;</span>, <span style='color:#c00000;'>&quot;&quot;</span>)
        eq.Residual <b><span style='color:#0000ff;'>=</span></b> <span style='color:#0000ff;'>self</span>.B() <b><span style='color:#0000ff;'>-</span></b> <span style='color:#0000ff;'>self</span>.kn() <b><span style='color:#0000ff;'>*</span></b> (<span style='color:#0000ff;'>self</span>.delta_c()<b><span style='color:#0000ff;'>**</span></b><span style='color:#0000ff;'>self</span>.n)
        eq.CheckUnitsConsistency <b><span style='color:#0000ff;'>=</span></b> <span style='color:#0000ff;'>False</span>

        <span style='color:#008000;'># Nucleation kinetics</span>
        eq <b><span style='color:#0000ff;'>=</span></b> <span style='color:#0000ff;'>self</span>.CreateEquation(<span style='color:#c00000;'>&quot;delta_c&quot;</span>, <span style='color:#c00000;'>&quot;&quot;</span>)
        eq.Residual <b><span style='color:#0000ff;'>=</span></b> <span style='color:#0000ff;'>self</span>.delta_c() <b><span style='color:#0000ff;'>-</span></b> (<span style='color:#0000ff;'>self</span>.c() <b><span style='color:#0000ff;'>-</span></b> <span style='color:#0000ff;'>self</span>.c_star()) <b><span style='color:#0000ff;'>*</span></b> <span style='color:#0000ff;'>self</span>.rho_s() <b><span style='color:#0000ff;'>/</span></b> <span style='color:#0000ff;'>self</span>.MW()
        
        <span style='color:#008000;'># Growth kinetics</span>
        <span style='color:#008000;'># A safe-guard: prevent the negative concentration by setting the growth rate to zero</span>
        <span style='color:#008000;'># if the supersaturation drops below one (that is no driving force)</span>
        <span style='color:#0000ff;'>self</span>.IF(<span style='color:#0000ff;'>self</span>.S() <b><span style='color:#0000ff;'>&gt;</span></b> <span style='color:#c000c0;'>1</span>)
        eq <b><span style='color:#0000ff;'>=</span></b> <span style='color:#0000ff;'>self</span>.CreateEquation(<span style='color:#c00000;'>&quot;G&quot;</span>, <span style='color:#c00000;'>&quot;&quot;</span>)
        eq.Residual <b><span style='color:#0000ff;'>=</span></b> <span style='color:#0000ff;'>self</span>.G() <b><span style='color:#0000ff;'>-</span></b> <span style='color:#0000ff;'>self</span>.kg() <b><span style='color:#0000ff;'>*</span></b> Exp(<b><span style='color:#0000ff;'>-</span></b><span style='color:#0000ff;'>self</span>.Ea() <b><span style='color:#0000ff;'>/</span></b> (<span style='color:#0000ff;'>self</span>.R() <b><span style='color:#0000ff;'>*</span></b> <span style='color:#0000ff;'>self</span>.T())) <b><span style='color:#0000ff;'>*</span></b> (<span style='color:#0000ff;'>self</span>.delta_c()<b><span style='color:#0000ff;'>**</span></b><span style='color:#0000ff;'>self</span>.g)
        eq.CheckUnitsConsistency <b><span style='color:#0000ff;'>=</span></b> <span style='color:#0000ff;'>False</span>

        <span style='color:#0000ff;'>self</span>.ELSE()
        eq <b><span style='color:#0000ff;'>=</span></b> <span style='color:#0000ff;'>self</span>.CreateEquation(<span style='color:#c00000;'>&quot;G&quot;</span>, <span style='color:#c00000;'>&quot;&quot;</span>)
        eq.Residual <b><span style='color:#0000ff;'>=</span></b> <span style='color:#0000ff;'>self</span>.G()
        <span style='color:#0000ff;'>self</span>.END_IF()
        
        <span style='color:#008000;'># Moments</span>
        eq <b><span style='color:#0000ff;'>=</span></b> <span style='color:#0000ff;'>self</span>.CreateEquation(<span style='color:#c00000;'>&quot;Moment(0)&quot;</span>, <span style='color:#c00000;'>&quot;&quot;</span>)
        eq.Residual <b><span style='color:#0000ff;'>=</span></b> <span style='color:#0000ff;'>self</span>.m0.dt() <b><span style='color:#0000ff;'>-</span></b> <span style='color:#0000ff;'>self</span>.B()

        eq <b><span style='color:#0000ff;'>=</span></b> <span style='color:#0000ff;'>self</span>.CreateEquation(<span style='color:#c00000;'>&quot;Moment(1)&quot;</span>, <span style='color:#c00000;'>&quot;&quot;</span>)
        eq.Residual <b><span style='color:#0000ff;'>=</span></b> <span style='color:#0000ff;'>self</span>.m1.dt() <b><span style='color:#0000ff;'>-</span></b> <span style='color:#c000c0;'>1</span> <b><span style='color:#0000ff;'>*</span></b> <span style='color:#0000ff;'>self</span>.G() <b><span style='color:#0000ff;'>*</span></b> <span style='color:#0000ff;'>self</span>.m0() <b><span style='color:#0000ff;'>-</span></b> <span style='color:#0000ff;'>self</span>.B() <b><span style='color:#0000ff;'>*</span></b> (<span style='color:#0000ff;'>self</span>.L0()<b><span style='color:#0000ff;'>**</span></b><span style='color:#c000c0;'>1</span>)

        eq <b><span style='color:#0000ff;'>=</span></b> <span style='color:#0000ff;'>self</span>.CreateEquation(<span style='color:#c00000;'>&quot;Moment(2)&quot;</span>, <span style='color:#c00000;'>&quot;&quot;</span>)
        eq.Residual <b><span style='color:#0000ff;'>=</span></b> <span style='color:#0000ff;'>self</span>.m2.dt() <b><span style='color:#0000ff;'>-</span></b> <span style='color:#c000c0;'>2</span> <b><span style='color:#0000ff;'>*</span></b> <span style='color:#0000ff;'>self</span>.G() <b><span style='color:#0000ff;'>*</span></b> <span style='color:#0000ff;'>self</span>.m1() <b><span style='color:#0000ff;'>-</span></b> <span style='color:#0000ff;'>self</span>.B() <b><span style='color:#0000ff;'>*</span></b> (<span style='color:#0000ff;'>self</span>.L0()<b><span style='color:#0000ff;'>**</span></b><span style='color:#c000c0;'>2</span>)
        eq.Scaling <b><span style='color:#0000ff;'>=</span></b> <span style='color:#c000c0;'>1e5</span>

        eq <b><span style='color:#0000ff;'>=</span></b> <span style='color:#0000ff;'>self</span>.CreateEquation(<span style='color:#c00000;'>&quot;Moment(3)&quot;</span>, <span style='color:#c00000;'>&quot;&quot;</span>)
        eq.Residual <b><span style='color:#0000ff;'>=</span></b> <span style='color:#0000ff;'>self</span>.m3.dt() <b><span style='color:#0000ff;'>-</span></b> <span style='color:#c000c0;'>3</span> <b><span style='color:#0000ff;'>*</span></b> <span style='color:#0000ff;'>self</span>.G() <b><span style='color:#0000ff;'>*</span></b> <span style='color:#0000ff;'>self</span>.m2() <b><span style='color:#0000ff;'>-</span></b> <span style='color:#0000ff;'>self</span>.B() <b><span style='color:#0000ff;'>*</span></b> (<span style='color:#0000ff;'>self</span>.L0()<b><span style='color:#0000ff;'>**</span></b><span style='color:#c000c0;'>3</span>)
        eq.Scaling <b><span style='color:#0000ff;'>=</span></b> <span style='color:#c000c0;'>1e8</span>

        eq <b><span style='color:#0000ff;'>=</span></b> <span style='color:#0000ff;'>self</span>.CreateEquation(<span style='color:#c00000;'>&quot;Moment(4)&quot;</span>, <span style='color:#c00000;'>&quot;&quot;</span>)
        eq.Residual <b><span style='color:#0000ff;'>=</span></b> <span style='color:#0000ff;'>self</span>.m4.dt() <b><span style='color:#0000ff;'>-</span></b> <span style='color:#c000c0;'>4</span> <b><span style='color:#0000ff;'>*</span></b> <span style='color:#0000ff;'>self</span>.G() <b><span style='color:#0000ff;'>*</span></b> <span style='color:#0000ff;'>self</span>.m3() <b><span style='color:#0000ff;'>-</span></b> <span style='color:#0000ff;'>self</span>.B() <b><span style='color:#0000ff;'>*</span></b> (<span style='color:#0000ff;'>self</span>.L0()<b><span style='color:#0000ff;'>**</span></b><span style='color:#c000c0;'>4</span>)
        eq.Scaling <b><span style='color:#0000ff;'>=</span></b> <span style='color:#c000c0;'>1e10</span>

        eq <b><span style='color:#0000ff;'>=</span></b> <span style='color:#0000ff;'>self</span>.CreateEquation(<span style='color:#c00000;'>&quot;Moment(5)&quot;</span>, <span style='color:#c00000;'>&quot;&quot;</span>)
        eq.Residual <b><span style='color:#0000ff;'>=</span></b> <span style='color:#0000ff;'>self</span>.m5.dt() <b><span style='color:#0000ff;'>-</span></b> <span style='color:#c000c0;'>5</span> <b><span style='color:#0000ff;'>*</span></b> <span style='color:#0000ff;'>self</span>.G() <b><span style='color:#0000ff;'>*</span></b> <span style='color:#0000ff;'>self</span>.m4() <b><span style='color:#0000ff;'>-</span></b> <span style='color:#0000ff;'>self</span>.B() <b><span style='color:#0000ff;'>*</span></b> (<span style='color:#0000ff;'>self</span>.L0()<b><span style='color:#0000ff;'>**</span></b><span style='color:#c000c0;'>5</span>)
        eq.Scaling <b><span style='color:#0000ff;'>=</span></b> <span style='color:#c000c0;'>1e12</span>

        <span style='color:#008000;'># Normalized moments 0-5</span>
        moments <b><span style='color:#0000ff;'>=</span></b> [<span style='color:#0000ff;'>self</span>.m0(), <span style='color:#0000ff;'>self</span>.m1(), <span style='color:#0000ff;'>self</span>.m2(), <span style='color:#0000ff;'>self</span>.m3(), <span style='color:#0000ff;'>self</span>.m4(), <span style='color:#0000ff;'>self</span>.m5()]
        <b>for</b> k <b><span style='color:#0000ff;'>in</span></b> <span style='color:#0000ff;'>range</span>(<span style='color:#c000c0;'>0</span>, <span style='color:#0000ff;'>self</span>.Nm.NumberOfPoints):
            eq <b><span style='color:#0000ff;'>=</span></b> <span style='color:#0000ff;'>self</span>.CreateEquation(<span style='color:#c00000;'>&quot;NormalizedMoment(</span><span style='color:#0057ae;'>%d</span><span style='color:#c00000;'>)&quot;</span> <b><span style='color:#0000ff;'>%</span></b> k, <span style='color:#c00000;'>&quot;&quot;</span>)
            eq.Residual <b><span style='color:#0000ff;'>=</span></b> <span style='color:#0000ff;'>self</span>.m_norm(k) <b><span style='color:#0000ff;'>*</span></b> <span style='color:#0000ff;'>self</span>.m0() <b><span style='color:#0000ff;'>-</span></b> moments[k]
            eq.CheckUnitsConsistency <b><span style='color:#0000ff;'>=</span></b> <span style='color:#0000ff;'>False</span>

        <span style='color:#008000;'># Performance indicators</span>
        <span style='color:#008000;'># Crystals concentration (crystals yield)</span>
        eq <b><span style='color:#0000ff;'>=</span></b> <span style='color:#0000ff;'>self</span>.CreateEquation(<span style='color:#c00000;'>&quot;Yield&quot;</span>, <span style='color:#c00000;'>&quot;&quot;</span>)
        eq.Residual <b><span style='color:#0000ff;'>=</span></b> <span style='color:#0000ff;'>self</span>.Yield() <b><span style='color:#0000ff;'>-</span></b> <span style='color:#0000ff;'>self</span>.rho_c() <b><span style='color:#0000ff;'>*</span></b> <span style='color:#0000ff;'>self</span>.Kv() <b><span style='color:#0000ff;'>*</span></b> <span style='color:#0000ff;'>self</span>.m3() <b><span style='color:#0000ff;'>*</span></b> <span style='color:#0000ff;'>self</span>.V()
            
        eq <b><span style='color:#0000ff;'>=</span></b> <span style='color:#0000ff;'>self</span>.CreateEquation(<span style='color:#c00000;'>&quot;Yield_max&quot;</span>, <span style='color:#c00000;'>&quot;&quot;</span>)
        eq.Residual <b><span style='color:#0000ff;'>=</span></b> <span style='color:#0000ff;'>self</span>.Yield_max() <b><span style='color:#0000ff;'>-</span></b> <span style='color:#0000ff;'>self</span>.rho_c() <b><span style='color:#0000ff;'>*</span></b> <span style='color:#0000ff;'>self</span>.Kv() <b><span style='color:#0000ff;'>*</span></b> <span style='color:#0000ff;'>self</span>.m3() <b><span style='color:#0000ff;'>*</span></b> <span style='color:#0000ff;'>self</span>.V() <b><span style='color:#0000ff;'>-</span></b> <span style='color:#0000ff;'>self</span>.c()<b><span style='color:#0000ff;'>*</span></b><span style='color:#0000ff;'>self</span>.rho_s()<b><span style='color:#0000ff;'>*</span></b><span style='color:#0000ff;'>self</span>.V()

        eq <b><span style='color:#0000ff;'>=</span></b> <span style='color:#0000ff;'>self</span>.CreateEquation(<span style='color:#c00000;'>&quot;Recovery&quot;</span>, <span style='color:#c00000;'>&quot;&quot;</span>)
        eq.Residual <b><span style='color:#0000ff;'>=</span></b> <span style='color:#0000ff;'>self</span>.Recovery() <b><span style='color:#0000ff;'>-</span></b> <span style='color:#0000ff;'>self</span>.Yield() <b><span style='color:#0000ff;'>/</span></b> (<span style='color:#0000ff;'>self</span>.Yield_max() <b><span style='color:#0000ff;'>+</span></b> Constant(<span style='color:#c000c0;'>1E-20</span><b><span style='color:#0000ff;'>*</span></b>kg))

        eq <b><span style='color:#0000ff;'>=</span></b> <span style='color:#0000ff;'>self</span>.CreateEquation(<span style='color:#c00000;'>&quot;Ntotal&quot;</span>, <span style='color:#c00000;'>&quot;&quot;</span>)
        eq.Residual <b><span style='color:#0000ff;'>=</span></b> <span style='color:#0000ff;'>self</span>.Ntotal() <b><span style='color:#0000ff;'>-</span></b> <span style='color:#0000ff;'>self</span>.m0()

        eq <b><span style='color:#0000ff;'>=</span></b> <span style='color:#0000ff;'>self</span>.CreateEquation(<span style='color:#c00000;'>&quot;Ltotal&quot;</span>, <span style='color:#c00000;'>&quot;&quot;</span>)
        eq.Residual <b><span style='color:#0000ff;'>=</span></b> <span style='color:#0000ff;'>self</span>.Ltotal() <b><span style='color:#0000ff;'>-</span></b> <span style='color:#0000ff;'>self</span>.m1()

        eq <b><span style='color:#0000ff;'>=</span></b> <span style='color:#0000ff;'>self</span>.CreateEquation(<span style='color:#c00000;'>&quot;Atotal&quot;</span>, <span style='color:#c00000;'>&quot;&quot;</span>)
        eq.Residual <b><span style='color:#0000ff;'>=</span></b> <span style='color:#0000ff;'>self</span>.Atotal() <b><span style='color:#0000ff;'>-</span></b> <span style='color:#0000ff;'>self</span>.Ka() <b><span style='color:#0000ff;'>*</span></b> <span style='color:#0000ff;'>self</span>.m2()

        eq <b><span style='color:#0000ff;'>=</span></b> <span style='color:#0000ff;'>self</span>.CreateEquation(<span style='color:#c00000;'>&quot;Vtotal&quot;</span>, <span style='color:#c00000;'>&quot;&quot;</span>)
        eq.Residual <b><span style='color:#0000ff;'>=</span></b> <span style='color:#0000ff;'>self</span>.Vtotal() <b><span style='color:#0000ff;'>-</span></b> <span style='color:#0000ff;'>self</span>.Kv() <b><span style='color:#0000ff;'>*</span></b> <span style='color:#0000ff;'>self</span>.m3()

        eq <b><span style='color:#0000ff;'>=</span></b> <span style='color:#0000ff;'>self</span>.CreateEquation(<span style='color:#c00000;'>&quot;D10&quot;</span>, <span style='color:#c00000;'>&quot;&quot;</span>)
        eq.Residual <b><span style='color:#0000ff;'>=</span></b> <span style='color:#0000ff;'>self</span>.D10() <b><span style='color:#0000ff;'>*</span></b> <span style='color:#0000ff;'>self</span>.m0() <b><span style='color:#0000ff;'>-</span></b> <span style='color:#0000ff;'>self</span>.m1()

        eq <b><span style='color:#0000ff;'>=</span></b> <span style='color:#0000ff;'>self</span>.CreateEquation(<span style='color:#c00000;'>&quot;D43&quot;</span>, <span style='color:#c00000;'>&quot;&quot;</span>)
        eq.Residual <b><span style='color:#0000ff;'>=</span></b> <span style='color:#0000ff;'>self</span>.D43() <b><span style='color:#0000ff;'>*</span></b> <span style='color:#0000ff;'>self</span>.m3() <b><span style='color:#0000ff;'>-</span></b> <span style='color:#0000ff;'>self</span>.m4()

<b>class</b> simTutorial(daeSimulation):
    <b>def</b> <b><span style='color:#000e52;'>__init__</span></b>(<span style='color:#0000ff;'>self</span>):
        daeSimulation.<b><span style='color:#000e52;'>__init__</span></b>(<span style='color:#0000ff;'>self</span>)
        <span style='color:#0000ff;'>self</span>.m <b><span style='color:#0000ff;'>=</span></b> modTutorial(<span style='color:#c00000;'>&quot;tutorial_che_3&quot;</span>)

    <b>def</b> SetUpParametersAndDomains(<span style='color:#0000ff;'>self</span>):
        <span style='color:#0000ff;'>self</span>.m.Nm.CreateArray(<span style='color:#c000c0;'>6</span>)

        <span style='color:#0000ff;'>self</span>.m.V.SetValue(<span style='color:#c000c0;'>0.5e-3</span> <b><span style='color:#0000ff;'>*</span></b> m<b><span style='color:#0000ff;'>**</span></b><span style='color:#c000c0;'>3</span>)
        
        <span style='color:#0000ff;'>self</span>.m.R.SetValue(<span style='color:#c000c0;'>8.3144</span> <b><span style='color:#0000ff;'>*</span></b> J<b><span style='color:#0000ff;'>/</span></b>(mol<b><span style='color:#0000ff;'>*</span></b>K))
        <span style='color:#0000ff;'>self</span>.m.MW.SetValue(<span style='color:#c000c0;'>151.163</span> <b><span style='color:#0000ff;'>*</span></b> g<b><span style='color:#0000ff;'>/</span></b>mol)
        
        <span style='color:#0000ff;'>self</span>.m.kg.SetValue(<span style='color:#c000c0;'>9.979</span>)
        <span style='color:#0000ff;'>self</span>.m.Ea.SetValue(<span style='color:#c000c0;'>40560</span> <b><span style='color:#0000ff;'>*</span></b> J<b><span style='color:#0000ff;'>/</span></b>mol)

        <span style='color:#0000ff;'>self</span>.m.kn.SetValue(<span style='color:#c000c0;'>1.597E10</span><b><span style='color:#0000ff;'>/</span></b><span style='color:#c000c0;'>60.0</span> <b><span style='color:#0000ff;'>*</span></b> ((s<b><span style='color:#0000ff;'>**</span></b>(<b><span style='color:#0000ff;'>-</span></b><span style='color:#c000c0;'>1</span>))<b><span style='color:#0000ff;'>*</span></b>(m<b><span style='color:#0000ff;'>**</span></b>(<b><span style='color:#0000ff;'>-</span></b><span style='color:#c000c0;'>3</span>))))

        <span style='color:#0000ff;'>self</span>.m.Ka.SetValue(<span style='color:#c000c0;'>5.196</span>)               <span style='color:#008000;'># Surface area shape factor</span>
        <span style='color:#0000ff;'>self</span>.m.Kv.SetValue(<span style='color:#c000c0;'>0.866</span>)               <span style='color:#008000;'># Volume shape factor</span>
        <span style='color:#0000ff;'>self</span>.m.rho_c.SetValue(<span style='color:#c000c0;'>1332</span> <b><span style='color:#0000ff;'>*</span></b> kg<b><span style='color:#0000ff;'>/</span></b>(m<b><span style='color:#0000ff;'>**</span></b><span style='color:#c000c0;'>3</span>)) <span style='color:#008000;'># Paracetamol</span>
        <span style='color:#0000ff;'>self</span>.m.rho_s.SetValue(<span style='color:#c000c0;'>789</span> <b><span style='color:#0000ff;'>*</span></b> kg<b><span style='color:#0000ff;'>/</span></b>(m<b><span style='color:#0000ff;'>**</span></b><span style='color:#c000c0;'>3</span>))  <span style='color:#008000;'># Ethanol</span>
        <span style='color:#0000ff;'>self</span>.m.cp_s.SetValue(<span style='color:#c000c0;'>112.4</span> <b><span style='color:#0000ff;'>*</span></b> J<b><span style='color:#0000ff;'>/</span></b>(kg<b><span style='color:#0000ff;'>*</span></b>K))  <span style='color:#008000;'># cp of Ethanol</span>
        <span style='color:#0000ff;'>self</span>.m.Qr.SetValue(<span style='color:#c000c0;'>0.0</span> <b><span style='color:#0000ff;'>*</span></b> W)             <span style='color:#008000;'># Cooling rate in Watts</span>
        <span style='color:#0000ff;'>self</span>.m.L0.SetValue(<span style='color:#c000c0;'>1e-6</span> <b><span style='color:#0000ff;'>*</span></b> m)            <span style='color:#008000;'># 1um</span>

    <b>def</b> SetUpVariables(<span style='color:#0000ff;'>self</span>):
        <span style='color:#008000;'># Initial conditions</span>
        <span style='color:#0000ff;'>self</span>.m.T.SetInitialCondition(<span style='color:#c000c0;'>293.15</span> <b><span style='color:#0000ff;'>*</span></b> K)
        <span style='color:#0000ff;'>self</span>.m.c.SetInitialCondition(<span style='color:#c000c0;'>0.275395968</span> <b><span style='color:#0000ff;'>*</span></b> kg<b><span style='color:#0000ff;'>/</span></b>kg)
        
        <span style='color:#008000;'># Actung, Achtung!!</span>
        <span style='color:#008000;'># Initial moments for 1.0081g of 125-250um seed (as in Niall's paper)</span>
        <span style='color:#008000;'># The meaning of the above: the values are given in m**k per gram of paracetamol,</span>
        <span style='color:#008000;'># and need to be transformed into the values in m**k/m**3</span>
        m_seed <b><span style='color:#0000ff;'>=</span></b> numpy.array([<span style='color:#c000c0;'>514967.2105</span> <b><span style='color:#0000ff;'>*</span></b> (m<b><span style='color:#0000ff;'>**</span></b><span style='color:#c000c0;'>0</span>)<b><span style='color:#0000ff;'>/</span></b>g,
                              <span style='color:#c000c0;'>42.56573654</span> <b><span style='color:#0000ff;'>*</span></b> (m<b><span style='color:#0000ff;'>**</span></b><span style='color:#c000c0;'>1</span>)<b><span style='color:#0000ff;'>/</span></b>g,
                              <span style='color:#c000c0;'>0.005234078</span> <b><span style='color:#0000ff;'>*</span></b> (m<b><span style='color:#0000ff;'>**</span></b><span style='color:#c000c0;'>2</span>)<b><span style='color:#0000ff;'>/</span></b>g,
                              <span style='color:#c000c0;'>8.84516e-07</span> <b><span style='color:#0000ff;'>*</span></b> (m<b><span style='color:#0000ff;'>**</span></b><span style='color:#c000c0;'>3</span>)<b><span style='color:#0000ff;'>/</span></b>g,
                              <span style='color:#c000c0;'>1.90332e-10</span> <b><span style='color:#0000ff;'>*</span></b> (m<b><span style='color:#0000ff;'>**</span></b><span style='color:#c000c0;'>4</span>)<b><span style='color:#0000ff;'>/</span></b>g,
                              <span style='color:#c000c0;'>5.00159e-14</span> <b><span style='color:#0000ff;'>*</span></b> (m<b><span style='color:#0000ff;'>**</span></b><span style='color:#c000c0;'>5</span>)<b><span style='color:#0000ff;'>/</span></b>g])
        moments <b><span style='color:#0000ff;'>=</span></b> [<span style='color:#0000ff;'>self</span>.m.m0, <span style='color:#0000ff;'>self</span>.m.m1, <span style='color:#0000ff;'>self</span>.m.m2, <span style='color:#0000ff;'>self</span>.m.m3, <span style='color:#0000ff;'>self</span>.m.m4, <span style='color:#0000ff;'>self</span>.m.m5]
        <span style='color:#008000;'># a) Change to moments per kg of ethanol: m_seed /= rho_EtOH*V</span>
        <span style='color:#008000;'>#    (in the Niall's paper moments are given in m**k/kg, therefore: m_seed /= 0.394 * g/kg)</span>
        <span style='color:#008000;'># b) Change to moments per m3 of ethanol: m_seed *= V (we use moments standardly given in m**k/m**3)</span>
        <span style='color:#008000;'># Also, the above numbers are given per one gram of seed - multiply the moments by actual weight of seed in grams</span>
        m_seed <b><span style='color:#0000ff;'>*=</span></b> (<span style='color:#c000c0;'>7.0109</span><b><span style='color:#0000ff;'>*</span></b>g) <b><span style='color:#0000ff;'>/</span></b> <span style='color:#0000ff;'>self</span>.m.V.GetQuantity()
        <span style='color:#008000;'>#print m_seed</span>
        <b>for</b> k <b><span style='color:#0000ff;'>in</span></b> <span style='color:#0000ff;'>range</span>(<span style='color:#c000c0;'>0</span>, <span style='color:#0000ff;'>self</span>.m.Nm.NumberOfPoints):
            moments[k].SetInitialCondition(m_seed[k])

<span style='color:#008000;'># Use daeSimulator class</span>
<b>def</b> guiRun(app):
    sim <b><span style='color:#0000ff;'>=</span></b> simTutorial()
    sim.m.SetReportingOn(<span style='color:#0000ff;'>True</span>)
    sim.ReportingInterval <b><span style='color:#0000ff;'>=</span></b> <span style='color:#c000c0;'>60</span>
    sim.TimeHorizon       <b><span style='color:#0000ff;'>=</span></b> <span style='color:#c000c0;'>3000</span>
    simulator  <b><span style='color:#0000ff;'>=</span></b> daeSimulator(app, simulation<b><span style='color:#0000ff;'>=</span></b>sim)
    simulator.exec_()

<span style='color:#008000;'># Setup everything manually and run in a console</span>
<b>def</b> consoleRun():
    <span style='color:#008000;'># Create Log, Solver, DataReporter and Simulation object</span>
    log          <b><span style='color:#0000ff;'>=</span></b> daePythonStdOutLog()
    daesolver    <b><span style='color:#0000ff;'>=</span></b> daeIDAS()
    datareporter <b><span style='color:#0000ff;'>=</span></b> daeTCPIPDataReporter()
    simulation   <b><span style='color:#0000ff;'>=</span></b> simTutorial()

    <span style='color:#008000;'># Relative tolerance</span>
    daesolver.RelativeTolerance <b><span style='color:#0000ff;'>=</span></b> <span style='color:#c000c0;'>1e-07</span>
    
    <span style='color:#008000;'># Enable reporting of all variables</span>
    simulation.m.SetReportingOn(<span style='color:#0000ff;'>True</span>)

    <span style='color:#008000;'># Set the time horizon and the reporting interval</span>
    simulation.ReportingInterval <b><span style='color:#0000ff;'>=</span></b> <span style='color:#c000c0;'>60</span>
    simulation.TimeHorizon       <b><span style='color:#0000ff;'>=</span></b> <span style='color:#c000c0;'>3000</span>

    <span style='color:#008000;'># Connect data reporter</span>
    simName <b><span style='color:#0000ff;'>=</span></b> simulation.m.Name <b><span style='color:#0000ff;'>+</span></b> strftime(<span style='color:#c00000;'>&quot; [</span><span style='color:#0057ae;'>%d</span><span style='color:#c00000;'>.%m.%Y %H:%M:%S]&quot;</span>, localtime())
    <b>if</b>(datareporter.Connect(<span style='color:#c00000;'>&quot;&quot;</span>, simName) <b><span style='color:#0000ff;'>==</span></b> <span style='color:#0000ff;'>False</span>):
        sys.exit()

    <span style='color:#008000;'># Initialize the simulation</span>
    simulation.Initialize(daesolver, datareporter, log)

    <span style='color:#008000;'># Save the model report and the runtime model report</span>
    simulation.m.SaveModelReport(simulation.m.Name <b><span style='color:#0000ff;'>+</span></b> <span style='color:#c00000;'>&quot;.xml&quot;</span>)
    simulation.m.SaveRuntimeModelReport(simulation.m.Name <b><span style='color:#0000ff;'>+</span></b> <span style='color:#c00000;'>&quot;-rt.xml&quot;</span>)

    <span style='color:#008000;'># Solve at time=0 (initialization)</span>
    simulation.SolveInitial()

    <span style='color:#008000;'># Run</span>
    simulation.Run()
    simulation.Finalize()

<b>if</b> <span style='color:#0000ff;'>__name__</span> <b><span style='color:#0000ff;'>==</span></b> <span style='color:#c00000;'>&quot;__main__&quot;</span>:
    <b>if</b> <span style='color:#0000ff;'>len</span>(sys.argv) <b><span style='color:#0000ff;'>&gt;</span></b> <span style='color:#c000c0;'>1</span> <b><span style='color:#0000ff;'>and</span></b> (sys.argv[<span style='color:#c000c0;'>1</span>] <b><span style='color:#0000ff;'>==</span></b> <span style='color:#c00000;'>'console'</span>):
        consoleRun()
    <b>else</b>:
        <span style='color:#0000ff;'>from</span> PyQt4 <span style='color:#0000ff;'>import</span> QtCore, QtGui
        app <b><span style='color:#0000ff;'>=</span></b> QtGui.QApplication(sys.argv)
        guiRun(app)
</pre>
</body>
</html>
